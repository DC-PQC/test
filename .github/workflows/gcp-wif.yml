name: GCP WIF Test

on:
  workflow_dispatch:   # run manually from Actions tab

permissions:
  id-token: write      # required for OIDC
  contents: read

jobs:
  test-wif:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Debug step: print OIDC token claims
      - name: Print OIDC Token Claims
        run: |
          echo "Requesting OIDC token from GitHub..."
          TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.googleapis.com" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')
          echo "Raw OIDC Token: $TOKEN"
          echo "Decoded claims:"
          echo "${TOKEN}" | cut -d "." -f2 | base64 -d | jq .

      # Authenticate to GCP using WIF
      - name: Authenticate to GCP via WIF
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: projects/238647468466/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Test access
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          CLOUDSDK_AUTH_ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        run: |
          echo "Authenticated as:"
          gcloud auth list
          echo "Listing buckets in project:"
          gcloud storage buckets list --project "${CLOUDSDK_CORE_PROJECT}"
